<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="utf-8" />
    <title>COBOL Structure Viewer</title>
    <link href="lib/tabulator.min.css" rel="stylesheet">
    <script src="lib/tabulator.min.js"></script>
    <style>
        :root {
            --sidebar-width: 450px;
            --primary-color: #2c3e50;
        }

        body, html {
            margin: 0; padding: 0; height: 100%; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            overflow: hidden; /* é˜²æ­¢ä¸»è¦–çª—æ²å‹• */
        }

        /* é ‚éƒ¨å°èˆªæ¬„ (é¸é…) */
        header {
            height: 50px; background: var(--primary-color); color: white;
            display: flex; align-items: center; padding: 0 20px; font-weight: bold;
        }

        /* ä¸»å®¹å™¨ */
        .wrapper {
            display: flex; height: calc(100% - 50px); transition: all 0.3s ease;
        }

        /* å·¦å´å´é‚Šæ¬„ */
        #sidebar {
            width: var(--sidebar-width);
            background: #f8f9fa;
            border-right: 1px solid #dee2e6;
            padding: 20px;
            box-sizing: border-box;
            transition: margin-left 0.3s ease;
            display: flex; flex-direction: column;
        }

        /* æ”¶ç´ç‹€æ…‹ */
        .collapsed #sidebar {
            margin-left: calc(var(--sidebar-width) * -1);
        }

        /* å³å´ä¸»å€åŸŸ */
        #content {
            flex-grow: 1;
            padding: 20px;
            overflow: hidden;
            display: flex; flex-direction: column;
        }

        /* åˆ‡æ›æŒ‰éˆ• */
        #toggle-btn {
            cursor: pointer; background: #fff; border: 1px solid #ccc;
            padding: 5px 10px; margin-bottom: 10px; align-self: flex-start;
        }
           
        .btn-sample {
            background: #6c757d; /* ç°è‰²ï¼Œè¡¨ç¤ºè¼”åŠ©åŠŸèƒ½ */
            color: white;
            border: none;
            padding: 8px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            margin-bottom: 10px;
            width: 100%;
            transition: background 0.2s;
        }

        .btn-sample:hover {
            background: #5a6268;
        }

        textarea {
            width: 95%; height: 300px; margin-bottom: 15px ; margin-top: 5px;
            border: 1px solid #ced4da; border-radius: 4px; padding: 10px;
            font-family: monospace; resize: none;
        }

        .btn-parse {
            background: #007bff; color: white; border: none; padding: 10px;
            border-radius: 4px; cursor: pointer; font-size: 16px;
        }

        .btn-parse:hover { background: #0056b3; }

        #selection-info {
            margin-top: 10px;margin-bottom: 10px; padding: 10px; background: #e9ecef; border-radius: 4px; font-size: 14px;
        }

        /* è®“è¡¨æ ¼å¡«æ»¿å‰©é¤˜ç©ºé–“ */
        #example-table { flex-grow: 1; border: 1px solid #ccc; }
    </style>
</head>
<body>
<header>COBOL Copybook Analyzer v1.0</header> 

<div class="wrapper" id="mainWrapper">
    <aside id="sidebar">
        <h3>è¼¸å…¥ Copybook</h3>
        <button class="btn-sample" onclick="loadSample()">è¼‰å…¥æ¸¬è©¦ç¯„ä¾‹ (REC-FACTURE)</button>
        <textarea id="cobolInput" placeholder="åœ¨æ­¤è²¼ä¸Š COBOL ä»£ç¢¼..."></textarea>
        <button class="btn-parse" onclick="parseCobol()">é–‹å§‹è§£æ</button>
        
        
    </aside>

    <main id="content">
        <button id="toggle-btn" onclick="toggleSidebar()">â˜° æ”¶ç´/å±•é–‹é¸å–®</button>
        <div id="selection-info">é¸å–å…©å€‹æ¬„ä½ä»¥è¨ˆç®—é–“éš™...</div>
        <div id="example-table"></div>
    </main>
</div>

    <script>
    var table = new Tabulator("#example-table", {    
    dataTree: true,
    selectableRows:2,// é™åˆ¶æœ€å¤šåªèƒ½é¸å– 2 è¡Œ    
    layout: "fitColumns",
    // dataTreeChildField: "children",
        dataTreeStartExpanded: true,
        layout: "fitColumns",
        rowFormatter: function(row) {
            var data = row.getData();
            if (data.isGap) {
                row.getElement().style.backgroundColor = "#fff5f5";
                row.getElement().style.color = "#e53e3e";
            } else if (data.redefines) {
                row.getElement().style.backgroundColor = "#f5f3ff";
            }
        },
    columns: [
        {formatter:"rowSelection", titleFormatter:"rowSelection", hozAlign:"center", headerSort:false, width:120}, // åŠ å…¥æ ¸å–æ–¹å¡Š
        // {title: "Level", field: "LevelString", width: 80},
        {
        title: "Level", 
        field: "LevelString", 
        width: 70, 
        formatter: function(cell) {
        let data = cell.getData();
        let depth = data.Depth || 0;
        
        // ä½¿ç”¨ &nbsp; (ä¸æ›è¡Œç©ºç™½) æ ¹æ“šæ·±åº¦é‡è¤‡å¢åŠ 
        // æ¯å¤šä¸€å±¤ï¼Œå‰é¢å°±å¤šåŠ ä¸€å€‹å…¨å½¢æˆ–åŠå½¢ç©ºç™½
        let spaces = "&nbsp;".repeat(depth * 2); // é€™è£¡ * 2 æ˜¯ç‚ºäº†è®“è¦–è¦ºç¸®æ’æ›´æ˜é¡¯
        
        // å¦‚æœæ˜¯ Gap å‰‡ä¸éœ€è¦ç¸®æ’æˆ–å¦å¤–è™•ç†
        // if (data.isGap) {
        //     return `<span style="color: #d9534f;">${cell.getValue()}</span>`;
        // }
        
        return `<span>${spaces}${cell.getValue()}</span>`;
        }
        },
        // {title: "æ¬„ä½åç¨±", field: "FieldName", width: 250},
        {
        title: "æ¬„ä½åç¨±", 
        field: "FieldName", 
        width: 300, 
        formatter: function(cell) {
        let data = cell.getData();
        let depth = data.Depth || 0;
        
        // ä½¿ç”¨ &nbsp; (ä¸æ›è¡Œç©ºç™½) æ ¹æ“šæ·±åº¦é‡è¤‡å¢åŠ 
        // æ¯å¤šä¸€å±¤ï¼Œå‰é¢å°±å¤šåŠ ä¸€å€‹å…¨å½¢æˆ–åŠå½¢ç©ºç™½
        let spaces = "&nbsp;".repeat(depth * 2); // é€™è£¡ * 2 æ˜¯ç‚ºäº†è®“è¦–è¦ºç¸®æ’æ›´æ˜é¡¯
        
        // å¦‚æœæ˜¯ Gap å‰‡ä¸éœ€è¦ç¸®æ’æˆ–å¦å¤–è™•ç†
        // if (data.isGap) {
        //     return `<span style="color: #d9534f;">${cell.getValue()}</span>`;
        // }
        
        return `<span>${spaces}${cell.getValue()}</span>`;
        }
        },
        // {title: "Structure / Repeat", field: "meta", width: 180, formatter: function(cell) {
        //         let data = cell.getData();
        //         let html = "";
        //         if (data.redefines) html += `<span style="background:#edf2ff; color:#364fc7; padding:2px 6px; border-radius:4px; font-size:11px;">ğŸ”„ REDEF: ${data.redefines}</span> `;
        //         if (data.occurs > 0) html += `<span style="background:#fff4e6; color:#d9480f; padding:2px 6px; border-radius:4px; font-size:11px;">ğŸ”¢ x${data.occurs}</span>`;
        //         return html;
        //     }},
        {title: "èµ·å§‹ä½ç½®", field: "Position",width: 90, hozAlign: "right"},
        {title: "çµ‚æ­¢ä½ç½®", field: "EndPosition",width: 90, hozAlign: "right"},
        {title: "é•·åº¦", field: "StorageLength",width: 90, hozAlign: "right"},
        {title: "Occurs", field: "Occurs"},
        {title: "ç¸½é•·åº¦", field: "TotalStorageLength",width: 90, hozAlign: "right"},
        {title: "Picture", field: "Picture"},
        {title: "NumericClass", field: "NumericClass"},
        {title: "DependingOn", field: "DependingOn"},
        {title: "isFieldRedefined", field: "isFieldRedefined"},
        {title: "isFieldRedefines", field: "isFieldRedefines"},
        {title: "RedefinesFieldName", field: "RedefinesFieldName"},        
        {title: "Usage", field: "Usage"},
        {title: "Value", field: "Value"}

    ],
    
});



// Subscribe to the rowSelectionChanged event

table.on("rowSelectionChanged", function(data, rows) {

    console.log("Selection changed using table.on():", data.length);
    document.getElementById("selection-info").innerHTML = calculateGap(data);
    

});

// åˆ‡æ›å´é‚Šæ¬„
    function toggleSidebar() {
        document.getElementById("mainWrapper").classList.toggle("collapsed");
        // é‡è¦ï¼šå´é‚Šæ¬„æ”¶æ”¾æ™‚ï¼Œè¡¨æ ¼éœ€è¦é‡ç¹ªä»¥é©æ‡‰æ–°å¯¬åº¦
        setTimeout(() => {
            table.redraw(true);
        }, 310);
    }

        function parseCobol() {
    var content = document.getElementById("cobolInput").value;
    fetch('/api/parseInDepth', {
        method: 'POST',
        headers: { 'Content-Type': 'text/plain' },
        body: content
    })
    .then(response => response.json())
    .then(res => {
        if(res.success==true)
    {
        table.setData(res.data);
    }        
    else
    {
        document.getElementById("selection-info").innerHTML = res.error;        
    }
        // expandAll();
    });
}

function expandAll() {
  table.getRows().forEach((row) => {
    if (!row._row.modules.dataTree.children) {
      return
    }

    row._row.modules.dataTree.open = true
    requestAnimationFrame(() => {
      row._row.updateData(row._row.data)
    })
  })
}
function collapseAll() {
  table.getRows().forEach((row) => {
    if (!row._row.modules.dataTree.children) {
      return
    }

    row._row.modules.dataTree.open = false
    requestAnimationFrame(() => {
      row._row.updateData(row._row.data)
    })
  })
}1

function calculateGap(selectedData) {
    console.log("calculateGap");   
    console.log(selectedData);   
     
    if (selectedData.length !== 2) {
        return "è«‹é¸å–å…©å€‹æ¬„ä½ä¾†è¨ˆç®—é–“è·...";
    }

    // æ’åºé¸å–çš„è³‡æ–™ï¼Œç¢ºä¿ä¾ position ç”±å°åˆ°å¤§
    selectedData.sort((a, b) => a.position - b.position);

    let first = selectedData[0];
    let second = selectedData[1];

    let firstEnd = first.Position + first.StorageLength - 1;
    let gap = second.Position - (firstEnd + 1);

    let resultMsg = `
        <strong>è¨ˆç®—çµæœï¼š</strong><br>
        æ¬„ä½ A (${first.FieldName}) çµæŸæ–¼ä½ç½®: ${firstEnd}<br>
        æ¬„ä½ B (${second.FieldName}) é–‹å§‹æ–¼ä½ç½®: ${second.Position}<br>
    `;

    if (gap > 0) {
        resultMsg += `<span style="color: red;">âš ï¸ å…©è€…ä¹‹é–“æœ‰ ${gap} Bytes çš„ç©ºéš™ (å¯èƒ½å­˜åœ¨éš±è—çš„ FILLER)ã€‚</span>`;
    } else if (gap < 0) {
        resultMsg += `<span style="color: blue;">â„¹ï¸ å…©è€…é‡ç–Šäº† ${Math.abs(gap)} Bytes (å¯èƒ½æ˜¯ REDEFINES çµæ§‹)ã€‚</span>`;
    } else {
        resultMsg += `<span style="color: green;">âœ… å…©è€…ç·Šå¯†ç›¸é€£ï¼Œç„¡ç©ºéš™ã€‚</span>`;
    }

    return resultMsg;
}


function loadSample() {
    const sampleCode = `       01  REC-FACTURE.                                                 
           03  FS1                 PIC X.                               
           03  FS2.                                                     
               05  FS2A            PIC 9.                               
               05  RFS2B           PIC X(8).
               05  FS2B REDEFINES RFS2B  PIC 9(8).
           03  FS3.                                                     
               05  FS3A            PIC 9.                               
               05  FS3B            PIC X(10).                           
           03  FS4.                                                     
               05  FS4A            PIC 99.                              
               05  FS4B            PIC 99.                              
               05  FS4C            PIC 99.                              
           03  FS5                 PIC X(5).                            
           03  FS6                 PIC X(20).                           
           03  FS7                 PIC 9.                               
           03  FS8                 PIC S9(9)V99    COMP-3.              
           03  FS9                 PIC S9(9)V99    COMP-3.              
           03  FS10                PIC 9.                               
           03  FS11                PIC S9(9)V99    COMP-3.              
           03  FS12                PIC S9(9)V99    COMP-3.              
           03  FS13                PIC S9(9)V99    COMP-3.              
           03  FS14-15 OCCURS 10.                                       
               05  FS14            PIC 9.                               
               05  FS15            PIC S9(9)V99    COMP-3.              
               05  FS16            PIC S9(9)V99    COMP-3.              
           03  FS17 OCCURS 10      PIC S9(9)V99    COMP-3.              
           03 FS18                 PIC 9(6).                            
           03  FS19                PIC 9.                               
           03  FILLER              PIC X.`;

    // å¡«å…¥ textarea
    document.getElementById("cobolInput").value = sampleCode;
    
    // å¡«å…¥å¾Œè‡ªå‹•åŸ·è¡Œä¸€æ¬¡è§£æï¼Œæå‡ä½¿ç”¨è€…é«”é©—
     parseCobol(); 
}
    </script>
</body>
</html>